Web Print Release

Web based print release for CUPS.

Bits needed for Python
----------------------

Install the following:

   apt-get install python-pip python-cups pkpgcounter

As the user that will be running the app install required libraries:

   pip install flask
   pip install Flask-Caching
   pip install gunicorn

Run the app in development mode with the following command line:

   python app.py

Run the app with gunicorn for production:

   /home/printrelease/.local/bin/gunicorn -w 4 -b 0.0.0.0:4000 app:app

Configure WebPrintRelease to run as a service
---------------------------------------------

We will use Gunicorn as the web server for WebPrint Release.

As root create a new service file:

   vi /etc/systemd/system/WebPrintRelease.service

Paste the following into the file:

   [Unit]
   Description=Gunicorn instance to serve WebPrintRelease
   After=network.target

   [Service]
   User=printrelease
   Restart=on-failure
   WorkingDirectory=/home/printrelease/WebPrintRelease/
   ExecStart=/home/printrelease/.local/bin/gunicorn -w 2 -b 0.0.0.0:8080 app:app

   [Install]
   WantedBy=multi-user.target

Reload services, enable and start WebPrintRelease:

   systemctl daemon-reload
   systemctl enable WebPrintRelease
   systemctl start WebPrintRelease

Note: If the main page is slower that expected delete /tmp/webprint and restart service.
The folder may have been created by a different user and ownership is wrong.

Configure CUPS
--------------

Cups needs some configuration to work as a print release system.  We will setup the default 
state of new jobs to "Held", change the default visibility of job names and modify default 
cups permissions to limit who can release jobs. We will also tweak PolicyKit to allow the 
print release user to release jobs.

First lets force new print jobs into a held state. This needs to be done for each printer 
on the server:

   lpadmin -p HP-LaserJet-400-M401 -o job-hold-until-default=indefinite

By default the print release user can't see job information for other users. To allow the 
display of job names and user names edit /etc/cups/cupsd.conf and edit the following:

<Policy default>
  JobPrivateAccess default
  JobPrivateValues none

Add the  print release user to the lpadmin group:

   usermod -G lpadmin -a printrelease

To allow the print release user (members of the lpadmin group) to release jobs they don't 
own create /etc/polkit-1/localauthority/50-local.d/allow-job-not-owned-edit.pkla with the 
following contents:

[Print job release not owned allow]
Identity=unix-group:lpadmin
Action=org.opensuse.cupspkhelper.mechanism.job-not-owned-edit
ResultAny=yes
ResultInactive=yes
ResultActive=yes

Now we need to edit /etc/cups/cupsd.conf and remove some rights from OWNER. To do that we 
create a new group under the default and authenticated policy and MOVE Release-Job 
Restart-Job Resume-Job Set-Job-Attributes to that group.  Notice only @SYSTEM has access 
to these actions. @SYSTEM refers to the lpadmin group:

Inside <Policy default>:

  <Limit Release-Job Restart-Job Resume-Job Set-Job-Attributes>
    Require user @SYSTEM
    Order deny,allow
  </Limit>

Inside <Policy authenticated>:

  <Limit Release-Job Restart-Job Resume-Job Set-Job-Attributes>
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  </Limit>

Note: Set-Job-Attributes is actually the key permission used here.
